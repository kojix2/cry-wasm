<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.28
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'>
<h1 id="label-cry-wasm">cry-wasm</h1>

<p><a href="https://github.com/kojix2/cry-wasm/actions/workflows/ci.yml"><img src="https://github.com/kojix2/cry-wasm/actions/workflows/ci.yml/badge.svg"></a></p>

<p>cry-wasm speeds up <a href="https://github.com/ruby/ruby">Ruby</a> code.</p>

<p>By applying simple type restrictions to Ruby code, convert it to <a href="https://github.com/crystal-lang/crystal">Crystal</a> code, compile it to <a href="https://webassembly.org/">WebAssembly</a>, and call it with <a href="https://github.com/wasmerio/wasmer">Wasmer</a>.</p>
<div align="center"><img src="doc/overview.drawio.png" width=50% height=50%></div>
<p>:space_invader: <em>highly experimental</em></p>

<h2 id="label-Quick+Start">Quick Start</h2>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>cry/wasm</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>Fibonacci</span>
  <span class='id identifier rubyid_extend'>extend</span> <span class='const'><span class='object_link'><a href="Cry.html" title="Cry (module)">Cry</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Cry/Wasm.html" title="Cry::Wasm (module)">Wasm</a></span></span>            <span class='comment'># &lt;-- Extend Cry::Wasm module
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='semicolon'>;</span> <span class='kw'>end</span>

  <span class='id identifier rubyid_cry'>cry</span> <span class='lbracket'>[</span><span class='symbol'>:Int32</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:Int32</span>        <span class='comment'># &lt;-- Set crystal [argument], return types
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_fib'>fib</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_n'>n</span> <span class='op'>&lt;=</span> <span class='int'>1</span>
      <span class='int'>1</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_fib'>fib</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span> <span class='op'>-</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='id identifier rubyid_fib'>fib</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span> <span class='op'>-</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_cry_wasm'>cry_wasm</span>                    <span class='comment'># &lt;-- Crystal compiles the fib method into Wasm.
</span><span class='kw'>end</span>

<span class='const'>Fibonacci</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_fib'>fib</span><span class='lparen'>(</span><span class='int'>40</span><span class='rparen'>)</span>         <span class='comment'># &lt;-- The wasm function is called here!
</span></code></pre>

<h2 id="label-Benchmark">Benchmark</h2>

<p><a href="https://github.com/kojix2/cry-wasm/blob/main/examples/fib_bench.rb">fib_bench.rb</a> - 10 x faster on the <a href="https://crystal-lang.org/2016/07/15/fibonacci-benchmark/">Fibonacci benchmark</a>.</p>

<pre class="code ruby"><code class="ruby">user     system      total        real
fib_ruby(40)  7.461878   0.004760   7.466638 (  7.466798)
fib_wasm(40)  0.628013   0.000025   0.628038 (  0.628096)
</code></pre>

<p>&lt;img src=“<img src="https://user-images.githubusercontent.com/5798442/205485566-5f7d1bae-4908-43a1-8f9a-801ae8d7d33e.png" />” width=20% height=“20%”&gt;</p>

<h2 id="label-How+does+this+work-3F">How does this work?</h2>

<pre class="code ruby"><code class="ruby">flowchart LR
style id1 fill:#c5c,stroke:#f66,stroke-width:1px,color:#fff
style id2 fill:#555,stroke:#3ff,stroke-width:1px,color:#fff
style id3 fill:#66f,stroke:#f66,stroke-width:1px,color:#fff
style id4 fill:#c5c,stroke:#ff1,stroke-width:1px,color:#fff
    id1(Ruby Methods) -- Ripper + Sorcerer --&gt; id2(Crystal Functions) -- Crystal Compiler --&gt; id3[WebAssembly]
    id4(Ruby Code) &lt;-- Wasmer/Wasmtime --&gt; id3[WebAssembly]
</code></pre>
<ol><li>
<p>Extend the Cry::Wasm module to the target class.</p>
</li><li>
<p>Write the type information just before the method.</p>
</li><li>
<p>Use the <code>cry</code> method to restrict argument types and return types.</p>
</li><li>
<p>Once the method is defined, Cry::Wasm captures the source code.</p>
</li><li>
<p><a href="https://ruby-doc.org/stdlib-3.1.2/libdoc/ripper/rdoc/Ripper.html">Ripper</a> converts source code to <a href="https://en.wikipedia.org/wiki/S-expression">S-expression</a>.</p>
</li><li>
<p>Extracts the S-expression of the target method from the S-expression.</p>
</li><li>
<p><a href="https://github.com/rspec-given/sorcerer">Sorcerer</a> recovers the Ruby source code of the target method from the S-expression.</p>
</li><li>
<p>Add Crystal type restrictions to the Ruby source code to generate a Crystal code block.</p>
</li><li>
<p>Cry::Wasm stores the Crystal code block.</p>
</li><li>
<p>The Crystal compiler and wasm-ld compile the Crystal code into WebAssembly.</p>
</li><li>
<p>Call the <code>cry_wasm</code> method to build the crystal code blocks.</p>
</li><li>
<p>The compiled byte_code is read, and an instance of Wasmer is created.</p>
</li><li>
<p>The target methods are dynamically redefined to call Wasmer functions.</p>
</li></ol>

<h2 id="label-Limitations">Limitations</h2>
<ul><li>
<p>Cry::Wasm allows you to define functions, not Crystal methods</p>
</li><li>
<p>default arguments, keyword arguments, and block arguments are not available.</p>
</li><li>
<p>Currently, only numbers are accepted as arguments. In the future, strings may also be acceptable.</p>
</li></ul>

<h2 id="label-Type+conversion">Type conversion</h2>

<p>:construction: work in progress :pick:</p>

<h3 id="label-Arguments+-+Ruby+---3E+Crystal">Arguments - Ruby –&gt; Crystal</h3>

<table role="table">
<thead>
<tr>
<th>Ruby class</th>
<th>Crystal class</th>
</tr>
</thead>
<tbody>
<tr>
<td>`Integer`</td>
<td>`UInt8` `Int8` `UInt16` `Int16` `UInt32` `Int32` `UInt64` `Int64`</td>
</tr>
<tr>
<td>`Float`</td>
<td>`Float32` `Float64`</td>
</tr>
<tr>
<td>`Array(Integer)`</td>
<td>`UInt8*` `Int8*` `UInt16*` `Int16*` `UInt32*` `Int32*` `Array(UInt8)` `Array(Int8)` `Array(UInt16)` `Array(Int16)` `Array(UInt32)` `Array(Int32)`</td>
</tr>
</tbody>
</table>

<h3 id="label-Return+values+-+Crystal+---3E+Ruby">Return values - Crystal –&gt; Ruby</h3>

<table role="table">
<thead>
<tr>
<th>Crystal class</th>
<th>Ruby class</th>
</tr>
</thead>
<tbody>
<tr>
<td>`UInt8` `Int8` `UInt16` `Int16` `UInt32` `Int32` `UInt64` `Int64`</td>
<td>`Integer`</td>
</tr>
<tr>
<td>`Float32` `Float64`</td>
<td>`Float`</td>
</tr>
<tr>
<td>`UInt8*` `Int8*` `UInt16*` `Int16*` `UInt32*` `Int32*`</td>
<td>View object of Wasmer</td>
</tr>
</tbody>
</table>

<h2 id="label-Installation">Installation</h2>
<ol><li>
<p>Install <a href="https://github.com/crystal-lang/crystal">Crystal</a>. Installation instructions for each platform are <a href="https://crystal-lang.org/install/">here</a>.</p>
</li><li>
<p>Install <a href="https://www.rust-lang.org/">Rust</a>. Rust is required to compile the <a href="https://github.com/wasmerio/wasmer-ruby">wasmer gem</a>.</p>
</li><li>
<p>Install llvm for macOS and lld for Ubuntu. Set PATH so that <code>wasm-ld</code> can be called.</p>
<ol><li>
<p>For example, if you install llvm on macOS with homebrew, <code>PATH=&quot;/usr/local/opt/llvm/bin:$PATH&quot;</code> or <code>PATH=&quot;/opt/homebrew/Cellar/llvm/&lt;version&gt;/bin:$PATH&quot;</code></p>
</li></ol>
</li><li>
<p>Download <a href="https://github.com/lbguilherme/wasm-libs">WebAssembly Libs for WASI</a> with <code>rake vendor:wasi_libs</code></p>
</li></ol>

<pre class="code ruby"><code class="ruby"><span class='comment'># Not yet available. Please see development section.
</span><span class='id identifier rubyid_gem'>gem</span> <span class='id identifier rubyid_install'>install</span> <span class='id identifier rubyid_cry'>cry</span><span class='op'>/</span><span class='id identifier rubyid_wasm'>wasm</span>
</code></pre>

<p>Tested on macOS and Ubuntu using <a href="https://github.com/kojix2/cry-wasm/blob/main/.github/workflows/ci.yml">Github Actions</a>.</p>

<h2 id="label-Development">Development</h2>
<ul><li>
<p><a href="https://forum.crystal-lang.org/t/trying-out-wasm-support/4508">Trying out WASM Support</a> - A thread in the Crystal Forum on how to compile a wasm from crystal.</p>
</li><li>
<p><a href="https://github.com/lbguilherme/wasm-libs">wasm-libs</a> - WebAssembly Libs for WASI. You need to download the compiled wasm library.</p>
</li></ul>

<pre class="code ruby"><code class="ruby">git clone https://github.com/kojix2/cry-wasm
cd cry-wasm
bundle install
bundle exec rake vendor:wasi_libs
bundle exec ruby examples/fibonacci.rb
# rake install
</code></pre>
<ul><li>
<p><a href="https://qiita.com/kojix2/items/b233f1419b26f7fc0e1b">Crystal で WebAssembly に出力した関数を Ruby から呼び出す</a></p>
</li></ul>

<h2 id="label-license">license</h2>

<p>MIT</p>
</div></div>

      <div id="footer">
  Generated on Sat Dec 17 06:21:48 2022 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.28 (ruby-3.1.3).
</div>

    </div>
  </body>
</html>