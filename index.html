<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.37
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'>
<h1 id="label-cry-wasm">cry-wasm</h1>

<p><a href="https://github.com/kojix2/cry-wasm/actions/workflows/ci.yml"><img src="https://github.com/kojix2/cry-wasm/actions/workflows/ci.yml/badge.svg" alt="CI"></a> <a href="https://kojix2.github.io/cry-wasm/"><img src="https://img.shields.io/badge/docs-latest-blue.svg" alt="Docs Latest"></a></p>

<p>:zap: cry-wasm speeds up <a href="https://github.com/ruby/ruby">Ruby</a> code.</p>

<p>By applying simple type restrictions to Ruby code, convert it to <a href="https://github.com/crystal-lang/crystal">Crystal</a> code, compile it to <a href="https://webassembly.org/">WebAssembly</a>, and call it with <a href="https://github.com/wasmerio/wasmer">Wasmer</a> or <a href="https://github.com/bytecodealliance/wasmtime">Wasmtime</a>.</p>
<div align="center"><img src="https://raw.githubusercontent.com/kojix2/cry-wasm/main/doc/overview.drawio.png" width=50% height=50%></div>
<p>:space_invader: experimental</p>

<h2 id="label-Quick+Start">Quick Start</h2>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>cry/wasm</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>Fibonacci</span>
  <span class='id identifier rubyid_extend'>extend</span> <span class='const'><span class='object_link'><a href="Cry.html" title="Cry (module)">Cry</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Cry/Wasm.html" title="Cry::Wasm (module)">Wasm</a></span></span>            <span class='comment'># (1) Extend your class
</span>
  <span class='id identifier rubyid_cry'>cry</span> <span class='lbracket'>[</span><span class='symbol'>:Int32</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:Int32</span>        <span class='comment'># (2) Write type signatures
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_fib'>fib</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_　return'>　return</span> <span class='int'>1</span> <span class='kw'>if</span> <span class='id identifier rubyid_n'>n</span> <span class='op'>&lt;=</span> <span class='int'>2</span>
    <span class='id identifier rubyid_fib'>fib</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span> <span class='op'>-</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='id identifier rubyid_fib'>fib</span><span class='lparen'>(</span><span class='id identifier rubyid_n'>n</span> <span class='op'>-</span> <span class='int'>2</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_cry_build'>cry_build</span>                   <span class='comment'># (3) Compile Wasm
</span><span class='kw'>end</span>

<span class='const'>Fibonacci</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_fib'>fib</span><span class='lparen'>(</span><span class='int'>40</span><span class='rparen'>)</span>         <span class='comment'># (4) Call Wasm Function
</span></code></pre>
<ol><li>
<p>Extend Cry::Wasm module to your Ruby class.</p>
</li><li>
<p>Write Crystal type signatures for Ruby methods. The syntax is <code>[arg_t1, arg_t2], ret_t</code> (Symbol or String).</p>
</li><li>
<p>Crystal compiler compile the Ruby methods into WebAssembly as Crystal functions.</p>
</li><li>
<p>Finally, call the wasm function!</p>
</li></ol>

<h2 id="label-Benchmark">Benchmark</h2>

<p><a href="https://github.com/kojix2/cry-wasm/blob/main/examples/fib_bench.rb">fib_bench.rb</a> - 10 x faster on the <a href="https://crystal-lang.org/2016/07/15/fibonacci-benchmark/">Fibonacci benchmark</a>.</p>

<pre class="code ruby"><code class="ruby">user     system      total        real
ruby     fib(40)   5.305503   0.000000   5.305503 (  5.305696)
wasmtime fib(40)   0.462232   0.000000   0.462232 (  0.462247)
wasmer   fib(40)   0.381384   0.000000   0.381384 (  0.381401)
</code></pre>

<p>&lt;img src=“<a href="https://raw.githubusercontent.com/kojix2/cry-wasm/main/doc/benchmark.svg">raw.githubusercontent.com/kojix2/cry-wasm/main/doc/benchmark.svg</a>” width=“40%” height=“40%”&gt;&lt;img src=“<img src="https://raw.githubusercontent.com/kojix2/cry-wasm/main/doc/benchmark_plot.png" />” width=25% height=“25%”&gt;</p>
<ul><li>
<p>In this benchmark, Wasmer is about 10% faster than Wasmtime as of December 2022.</p>
</li><li>
<p>Both Wasmer and Wasmtime tend to take a little longer for the first call. (see line graph at n=1)</p>
</li><li>
<p>Wasm is only about twice as slow as native functions, making it highly efficient. (according to my measurements)</p>
</li></ul>

<h2 id="label-How+does+this+work-3F">How does this work?</h2>

<pre class="code ruby"><code class="ruby">flowchart LR
style id1 fill:#c5c,stroke:#f66,stroke-width:1px,color:#fff
style id2 fill:#555,stroke:#3ff,stroke-width:1px,color:#fff
style id3 fill:#66f,stroke:#f66,stroke-width:1px,color:#fff
style id4 fill:#c5c,stroke:#ff1,stroke-width:1px,color:#fff
    id1(Ruby Methods) -- Ripper + Sorcerer --&gt; id2(Crystal Functions) -- Crystal Compiler --&gt; id3[WebAssembly]
    id4(Ruby Code) &lt;-- Wasmer/Wasmtime --&gt; id3[WebAssembly]
</code></pre>
<ol><li>
<p>Extend the Cry::Wasm module to the target class.</p>
</li><li>
<p>Write the type information just before the method.</p>
</li><li>
<p>Use the <code>cry</code> method to restrict argument types and return types.</p>
</li><li>
<p>Once the method is defined, Cry::Wasm captures the source code.</p>
</li><li>
<p><a href="https://ruby-doc.org/stdlib-3.1.2/libdoc/ripper/rdoc/Ripper.html">Ripper</a> converts source code to <a href="https://en.wikipedia.org/wiki/S-expression">S-expression</a>.</p>
</li><li>
<p>Extracts the S-expression of the target method from the S-expression.</p>
</li><li>
<p><a href="https://github.com/rspec-given/sorcerer">Sorcerer</a> recovers the Ruby source code of the target method from the S-expression.</p>
</li><li>
<p>Add Crystal type restrictions to the Ruby source code to generate a Crystal code block.</p>
</li><li>
<p>Cry::Wasm stores the Crystal code block.</p>
</li><li>
<p>The Crystal compiler and wasm-ld compile the Crystal code into WebAssembly.</p>
</li><li>
<p>Call the <code>cry_build</code> method to build the crystal code blocks.</p>
</li><li>
<p>The compiled byte_code is read, and an instance of Wasmer/Wasmtime is created.</p>
</li><li>
<p>The target methods are dynamically redefined to call Wasmer/Wasmtime functions.</p>
</li></ol>

<h2 id="label-Usage">Usage</h2>

<h3 id="label-It+define+crystal+functions-2C+not+Crystal+methods">It define crystal functions, not Crystal methods</h3>
<ul><li>
<p>Default arguments, keyword arguments, and block arguments are not available.</p>
</li><li>
<p>Instance variables and class variables are not available on the top level function.</p>
</li><li>
<p>To use your own Crystal class, use <code>cry_load(path)</code> to pre-load your crystal source code.</p>
</li></ul>

<h3 id="label-Type+conversion">Type conversion</h3>

<h4 id="label-Arguments+-28+Ruby+---3E+Crystal+-29">Arguments ( Ruby –&gt; Crystal )</h4>

<table role="table">
<thead>
<tr>
<th>Ruby class</th>
<th>Crystal class</th>
</tr>
</thead>
<tbody>
<tr>
<td>‘Integer`</td>
<td>‘UInt8` `Int8` `UInt16` `Int16` `UInt32` `Int32` `UInt64` `Int64`</td>
</tr>
<tr>
<td>‘Float`</td>
<td>‘Float32` `Float64`</td>
</tr>
<tr>
<td>‘Array&lt;Integer&gt;`</td>
<td>‘UInt8*` `Int8*` `UInt16*` `Int16*` `UInt32*` `Int32*` `UInt64*` `Int64*`</td>
</tr>
<tr>
<td>‘Array&lt;Integer&gt;`</td>
<td>‘Array(UInt8)` `Array(Int8)` `Array(UInt16)` `Array(Int16)` `Array(UInt32)` `Array(Int32)` `Array(UInt64)` `Array(Int64)`</td>
</tr>
<tr>
<td>‘Array&lt;Float&gt;`</td>
<td>‘Float32*` `Float64*`</td>
</tr>
<tr>
<td>‘Array&lt;Float&gt;`</td>
<td>‘Array(Float32)` `Array(Float32)`</td>
</tr>
<tr>
<td>‘String`</td>
<td>‘String`</td>
</tr>
</tbody>
</table>

<h4 id="label-Return+values+-28+Crystal+---3E+Ruby+-29">Return values ( Crystal –&gt; Ruby )</h4>

<table role="table">
<thead>
<tr>
<th>Crystal class</th>
<th>Ruby class</th>
</tr>
</thead>
<tbody>
<tr>
<td>‘UInt8` `Int8` `UInt16` `Int16` `UInt32` `Int32` `UInt64` `Int64`</td>
<td>‘Integer`</td>
</tr>
<tr>
<td>‘Float32` `Float64`</td>
<td>‘Float`</td>
</tr>
<tr>
<td>‘UInt8*` `Int8*` `UInt16*` `Int16*` `UInt32*` `Int32*`</td>
<td>View object of Wasmer (wasmer only)</td>
</tr>
<tr>
<td>‘Array(UInt8)` `Array(Int8)` `Array(UInt16)` `Array(Int16)` `Array(UInt32)` `Array(Int32)` `Array(UInt64)` `Array(Int64)`</td>
<td>‘Array&lt;Integer&gt;`</td>
</tr>
<tr>
<td>‘Array(Float32)` `Array(Float32)`</td>
<td>‘Array&lt;Float&gt;`</td>
</tr>
<tr>
<td>‘String`</td>
<td>‘String`</td>
</tr>
<tr>
<td>‘Void`</td>
<td>‘Nil`</td>
</tr>
</tbody>
</table>

<h4 id="label-Why+is+Symbol+not+supported-3F">Why is <code>Symbol</code> not supported?</h4>

<p>In the Crystal language, Symbol is converted to an integer at compile time, so there is no way to get Symbol from a String; use <code>String</code> instead of <code>Symbol</code>.</p>

<h4 id="label-Cry-3A-3ANumeric+uses+Refinement+to+add+methods+to+Ruby-27s+numeric+classes">Cry::Numeric uses Refinement to add methods to Ruby’s numeric classes</h4>

<p><code>Cry::Numeric</code> can use Refinements to add methods such as <code>to_i8</code>, <code>to_u8</code>, and <code>to_f32</code> to Ruby’s numeric classes. These methods are the same as <code>to_i</code> and <code>to_f</code> (the range of values is not checked). These are useful if you want to prevent errors when running your code as Ruby and get the same results as if you had run it as Crystal.</p>

<h4 id="label-Why+is+it+very+slow+to+return+arrays-3F">Why is it very slow to return arrays?</h4>

<p>Currently reading memory in wasm and converting it to Ruby arrays takes quite a bit of time. As a result, it may take longer to run with cry-wasm than when run as pure Ruby. Also note that currently (2022/12) wasmtime-rb is faster than wasmer-ruby when it comes to reading memory. If you are interested in improving these issues, please consider contributing to wasmer-ruby or wasmtime-rb.</p>

<h2 id="label-Installation">Installation</h2>

<p>Requirements</p>
<ol><li>
<p><a href="https://github.com/crystal-lang/crystal">Crystal</a> - Follow the installation instructions <a href="https://crystal-lang.org/install/">here</a> for your platform.</p>
</li><li>
<p><a href="https://www.rust-lang.org/">Rust</a> - Rust is required to compile the <a href="https://github.com/wasmerio/wasmer-ruby">wasmer-ruby</a> or <a href="https://github.com/bytecodealliance/wasmtime-rb">wasmtime-rb</a>.</p>
</li><li>
<p><a href="https://llvm.org/">LLVM</a> for macOS:</p>
</li><li>
<p>Install LLVM by running <code>brew install llvm</code></p>
</li><li>
<p>Find the path to wasm-ld by running <code>brew ls llvm | grep wasm-ld</code>.</p>
</li><li>
<p>Set the PATH environment variable so that <code>wasm-ld</code> can be called.</p>
</li><li>
<p><a href="https://lld.llvm.org/">LLD</a> for Ubuntu:</p>
</li><li>
<p>Install LLD by running <code>sudo apt install lld</code>.</p>
</li><li>
<p>Find the path to wasm-ld by running <code>dpkg -L lld | grep wasm-ld</code>.</p>
</li><li>
<p>If necessary, create a symbolic link for <code>wasm-ld-9</code> or <code>wasm-ld-10</code>.</p>
</li><li>
<p><a href="https://github.com/lbguilherme/wasm-libs">WebAssembly Libs for WASI</a></p>
</li><li>
<p>Use the <code>rake vendor:wasi_libs</code> task to download the libs to the vendor directory.</p>
</li><li>
<p>If you install the libs outside the given directory, set the <code>CRYSTAL_LIBRARY_PATH</code> environment variable.</p>
</li></ol>

<p>Installation</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_bundle'>bundle</span> <span class='id identifier rubyid_install'>install</span>
<span class='id identifier rubyid_bundle'>bundle</span> <span class='id identifier rubyid_exec'>exec</span> <span class='id identifier rubyid_rake'>rake</span> <span class='label'>vendor:</span><span class='id identifier rubyid_wasi_libs'>wasi_libs</span>
<span class='id identifier rubyid_bundle'>bundle</span> <span class='id identifier rubyid_exec'>exec</span> <span class='id identifier rubyid_rake'>rake</span> <span class='id identifier rubyid_install'>install</span>
</code></pre>

<p>Please note that cry-wasm depends on the latest API of wasmer-ruby and wasmtime-rb, so we have to use the GitHub master rather than the stable version.</p>

<p>Tested on macOS and Ubuntu using <a href="https://github.com/kojix2/cry-wasm/blob/main/.github/workflows/ci.yml">Github Actions</a>. Windows is not yet supported.</p>

<h2 id="label-Development">Development</h2>

<pre class="code ruby"><code class="ruby">git clone https://github.com/kojix2/cry-wasm
cd cry-wasm
bundle install
bundle exec rake vendor:wasi_libs
bundle exec rake spec
</code></pre>
<ul><li>
<p><a href="https://forum.crystal-lang.org/t/trying-out-wasm-support/4508">Trying out WASM Support</a> - A thread in the Crystal Forum on how to compile a wasm from crystal.</p>
</li><li>
<p><a href="https://github.com/lbguilherme/wasm-libs">wasm-libs</a> - WebAssembly Libs for WASI. You need to download the compiled wasm library.</p>
</li></ul>

<p>Even small improvements like fixing typos are welcome! Please feel free to send us your PR.</p>

<h2 id="label-license">license</h2>

<p>MIT</p>
</div></div>

      <div id="footer">
  Generated on Tue Aug 12 00:00:47 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.4.5).
</div>

    </div>
  </body>
</html>